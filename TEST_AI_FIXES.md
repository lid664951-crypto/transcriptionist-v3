# AI功能修复测试指南

## 快速测试步骤

### 1. 测试导入速度（问题1修复验证）

**测试目标**：验证6000+文件导入速度是否提升

**步骤**：
1. 启动软件
2. 进入"音效库"页面
3. 点击"导入"按钮，选择包含6000+音频文件的文件夹
4. 观察进度条和时间

**预期结果**：
- 扫描阶段：1-3分钟（取决于硬盘速度）
- 元数据提取：2-5分钟
- 总时间：约5-15分钟（之前需要30-60分钟）

**如何判断是否成功**：
- 查看控制台日志，应该看到：
  ```
  [Balanced Mode] Processing 6000 files in chunks of 6000 (small_threshold=8000)
  元数据提取：进程内多进程，workers=X（库扫描并行数）
  ```
- 如果看到"Timeout"或"falling back to single process"，说明仍有问题

---

### 2. 测试AI检索精准度（问题3修复验证）

**测试目标**：验证检索结果是否精准

**步骤**：
1. 在音效库中勾选一些文件（建议100-1000个）
2. 进入"AI智能检索与打标"页面
3. 点击"建立AI检索索引"，等待完成
4. 在搜索框输入以下测试词：
   - "雷声" 或 "thunder"
   - "枪声" 或 "gunshot"
   - "脚步声" 或 "footsteps"
   - "风声" 或 "wind"
   - "爆炸" 或 "explosion"

**预期结果**：
- 搜索结果应该与搜索词高度相关
- 相似度分数应该在0.3-0.8之间（不应该全是0.1-0.2的低分）
- 排序应该合理（最相关的在前面）

**如何判断是否成功**：
- 搜索"雷声"应该返回雷声音效，而不是其他不相关的声音
- 相似度分数合理（修复前可能全是0.1-0.2，修复后应该0.3-0.8）

---

### 3. 测试AI智能打标（问题4修复验证）

**测试目标**：验证打标是否显示足够的标签

**步骤**：
1. 在音效库中勾选一些文件（建议10-100个）
2. 进入"AI智能检索与打标"页面
3. 如果还没有索引，点击"建立AI检索索引"
4. 切换到"智能打标"标签页
5. 选择"影视音效（753）"标签集
6. 将置信度阈值设置为**0.25**（这是关键！）
7. 点击"开始AI智能打标"
8. 观察日志和结果

**预期结果**：
- 每个文件应该显示3-8个标签（而不是1-2个）
- 日志中不应该频繁出现"无达标标签"的警告
- 标签应该与音频内容相关

**如何判断是否成功**：
- 打标完成后，在音效库中查看文件的标签列
- 应该看到多个标签，而不是只有1-2个
- 如果仍然只有1-2个标签，尝试降低阈值到0.20

---

### 4. 对比测试：不同标签集和阈值

**测试目标**：验证不同标签集的最佳阈值

**步骤**：
1. 准备相同的一批文件（建议10-50个）
2. 测试组合A：
   - 标签集：音效精简(70+)
   - 阈值：0.30
3. 测试组合B：
   - 标签集：影视音效（753）
   - 阈值：0.25
4. 测试组合C：
   - 标签集：全量AudioSet(527)
   - 阈值：0.30

**预期结果**：
- 短标签集（70+, 527）可以用更高阈值（0.30-0.35）
- 长句子标签集（753）需要更低阈值（0.20-0.25）
- 标签数量和质量应该合理

---

## 性能基准测试

### 导入性能基准

| 文件数量 | 修复前时间 | 修复后时间 | 提升倍数 |
|---------|-----------|-----------|---------|
| 1000    | 5-10分钟  | 1-2分钟   | 5倍     |
| 6000    | 30-60分钟 | 5-15分钟  | 4-6倍   |
| 10000   | 50-100分钟| 10-25分钟 | 5倍     |

### AI索引性能基准

| 文件数量 | 索引建立时间 | 检索时间 |
|---------|-------------|---------|
| 100     | 10-30秒     | <1秒    |
| 1000    | 2-5分钟     | 1-2秒   |
| 6000    | 10-30分钟   | 2-5秒   |
| 10000   | 20-50分钟   | 3-8秒   |

---

## 常见问题排查

### Q1: 导入仍然很慢，怎么办？

**检查点**：
1. 查看控制台日志，确认是否使用了多进程：
   ```
   元数据提取：进程内多进程，workers=X
   ```
2. 如果看到"falling back to single process"，说明超时了
3. 检查硬盘速度（机械硬盘会比SSD慢很多）
4. 检查CPU占用率（应该接近100%）

**解决方案**：
- 如果是机械硬盘，考虑升级到SSD
- 如果CPU占用率低，检查是否有其他程序占用资源
- 可以在设置中调整"库扫描并行数"

---

### Q2: 检索结果仍然不精准，怎么办？

**检查点**：
1. 确认模型文件完整：
   ```
   data/models/larger-clap-general/onnx/audio_model.onnx (约268MB)
   data/models/larger-clap-general/onnx/text_model.onnx (约478MB)
   data/models/larger-clap-general/tokenizer.json (约2MB)
   ```
2. 查看控制台日志，确认模型加载成功
3. 尝试重新建立索引

**解决方案**：
- 如果模型文件不完整，重新下载
- 清除旧索引，重新建立
- 尝试不同的搜索词

---

### Q3: 打标仍然只显示1-2个标签，怎么办？

**检查点**：
1. 确认置信度阈值设置为0.25或更低
2. 查看日志中的"最高相似度"信息
3. 确认使用的标签集

**解决方案**：
- 降低阈值到0.20或0.15
- 尝试使用短标签集（音效精简70+）
- 查看日志中的相似度分数，判断是否需要进一步降低阈值

---

### Q4: 如何判断阈值设置是否合理？

**经验法则**：
- 如果大部分文件只有1-2个标签 → 阈值太高，降低0.05
- 如果大部分文件有10+个标签 → 阈值太低，提高0.05
- 理想状态：大部分文件有3-8个标签

**标签集推荐阈值**：
- 音效精简(70+)：0.30-0.35
- 全量AudioSet(527)：0.30-0.35
- 影视音效（753）：0.20-0.25

---

## 日志分析

### 正常日志示例

```
[Balanced Mode] Processing 6000 files in chunks of 6000 (small_threshold=8000)
元数据提取：进程内多进程，workers=8（库扫描并行数）
CLAPIndexingWorker: using GPU batch_size=4 for 6000 files
CLAPIndexingWorker: finished embeddings for 6000/6000 files in 600.5s
索引完成：共 6000 条，耗时 600.5 秒
```

### 异常日志示例

```
[Chunk 1/3] Timeout after 600s, falling back to single process for this chunk
Multiprocessing extract failed: TimeoutError
```

如果看到这些日志，说明修复没有生效，请检查代码是否正确应用。

---

## 反馈与报告

如果测试中发现问题，请提供以下信息：
1. 文件数量
2. 硬件配置（CPU、内存、硬盘类型）
3. 控制台日志（完整的）
4. 具体的测试步骤和结果
5. 截图（如果有）

这将帮助进一步优化和修复问题。
