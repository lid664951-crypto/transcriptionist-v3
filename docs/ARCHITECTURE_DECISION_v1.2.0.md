# v1.2.0 架构决策记录（ADR）

## ADR-001：UI 框架重做方式

### 决策

- 继续使用 `PySide6 + qfluentwidgets`，不更换主 UI 技术栈。
- 通过“组件系统化 + 布局重构 + 设计令牌”实现现代化升级。

### 理由

- 当前项目已大量使用 Qt 组件与信号槽，强行换栈成本过高。
- 可在现有栈中实现接近 Soundly 的结构与视觉体验。

### 影响

- 优点：迁移风险低、可分阶段落地。
- 缺点：部分高级动效需自定义实现。

---

## ADR-002：百万级实时索引目标实现路径

### 决策

- 采用“事件驱动增量索引 + 任务系统恢复 + 查询编排层”路线。

### 理由

- 当前已有 `Job/JobItem/IndexShard` 基础，可扩展性较好。
- 增量优先比全量重建更符合“实时性”目标。

### 影响

- 优点：可持续扩展，支持断点恢复。
- 缺点：任务状态机复杂度提升。

---

## ADR-003：数据库引擎选型

### 决策

- `v1.2.0` 采用 `SQLite` 单后端路线（对齐 Soundly 的 `.sdb/SQLite` 方向）。
- 保留 SQLAlchemy + Alembic 作为结构迁移与模型抽象层。

### 备选比较

- SQLite：部署简单、桌面单机一致性好、备份迁移成本低，适合作为当前主路径。
- PostgreSQL：并发能力强，但引入独立服务部署和运维复杂度，不符合当前产品阶段。
- Milvus/Elastic：能力强，但运维与集成成本高，不适合作为当前版本主路径。

### 影响

- 优点：架构更收敛，安装与发布复杂度更低，和桌面端使用方式一致。
- 缺点：极端并发上限受单机约束，需要通过任务化和索引策略规避峰值风险。

### 落地状态（2026-02-07）

- 已完成连接层收敛为 SQLite-only（忽略非 `sqlite://` URL）。
- 已完成启动健康检查与 SQLite 轻量迁移保留（WAL + PRAGMA）。
- 已移除 SQLite->PostgreSQL 迁移脚本与依赖。
- 待完成：SQLite 数据模型持续演进与索引参数调优。

---

## ADR-004：检索层策略

### 决策

- 文本检索与向量检索分层实现，通过统一编排层融合排序。

### 理由

- 便于按场景调优：
  - 精准过滤走文本索引。
  - 语义召回走向量索引。

### 影响

- 优点：相关性更稳定，性能更可控。
- 缺点：需要维护融合策略与可解释性。

---

## ADR-005：Soundly 对标范围

### 决策

- 对标“信息架构、导入体验、监控机制、分页策略、并发搜索思想”。
- 不做“逐界面复刻”，保留音译家 AI 工作流特色。

### 理由

- 你的产品核心优势是 AI 工作流，不应被纯资产管理范式覆盖。

### 影响

- 优点：既学习成熟产品，又保持产品差异化。
- 缺点：UI 设计与实现需要更多取舍。

---

## ADR-006：工作区双向全屏交互决策

### 决策

- 工作站布局采用三态模式：`Split`、`LibraryFocus`、`WorkbenchFocus`。
- 中间分隔区域箭头按钮升级为双向聚焦入口，支持“聚焦音效库 / 聚焦工作台 / 恢复分栏”。
- 模式切换只改变布局可见性与比例，不重建核心页面实例。

### 理由

- 现有代码已具备左侧折叠能力（`CollapsiblePanel` + `QSplitter`），演进成本低。
- 你的真实使用场景是“浏览检索”和“工作流处理”两类专注模式频繁切换。
- 与 Soundly 的体验对标重点之一是“专注视图切换效率”，而非仅左侧单向收展。

### 影响

- 优点：显著提升双场景专注效率，减少频繁拖动分栏与重复点击。
- 优点：保持底部播放器与波形区域稳定，避免模式切换打断试听流程。
- 缺点：布局状态机与图标语义需要统一规范，否则容易产生认知歧义。
- 缺点：需要补齐状态保持测试，防止滚动位置、选中项在切换时丢失。
