# 音译家 v1.2.0 实施计划（落地版）

> 面向研发与测试的执行文档，聚焦“可交付、可验收、可回滚”。

## 1. 目标与边界

### 1.1 版本目标

- 导入任务后台化，避免主流程阻塞。
- 大库场景（10 万级）下保持可浏览、可搜索、可操作。
- 补齐文件监控接线，实现增量同步。
- 提升波形预览可用性与复用效率。

### 1.2 非目标（本版本不做）

- 不引入新的数据库引擎（继续使用 SQLite + SQLAlchemy）。
- 不重做整套 UI 框架。
- 不在本版本追求“百万级绝对实时索引”，仅完成稳定可扩展底座。

---

## 2. 当前基线（以现有代码为准）

- 已有导入队列流水线：`QueueScanWorker` + `ImportQueueWorker`。
- 已有大库 `paths_only` 加载分支与按需查询。
- 已有文件夹树与右侧音效列表分离架构。
- 已有文件监控模块，但尚未在主业务链路中接线。
- 波形预览当前为保守策略（以 WAV 为主），缓存模块未完全纳入播放链路。

---

## 3. 里程碑计划

## M1（P0）导入后台化与任务可见性

### 目标

- 导入不阻塞主界面操作。
- 导入状态可持续查看（即使关闭导入页面）。

### 任务清单

- 在 `ui/pages/library_page_qt.py` 中拆分“导入流程控制”和“导入界面展示”职责。
- 引入导入任务状态对象（任务 ID、阶段、进度、错误、可取消状态）。
- 保留现有 `ImportQueue` 机制，新增任务中心展示入口（可先简版）。

### 验收标准（DoD）

- 导入进行中可切换到 AI 翻译、AI 搜索页面正常操作。
- 导入任务可在界面外持续运行并最终回调成功/失败状态。
- 取消任务后，线程与进程池资源可回收，不残留悬挂任务。

---

## M2（P0）文件监控正式接线

### 目标

- 文件夹内新增/删除/重命名可自动增量同步到库。

### 任务清单

- 将 `application/library_manager/file_watcher.py` 接入库页或统一应用服务层。
- 设计事件合并策略：防抖 + 去重 + 批提交。
- 定义同步优先级：新增 > 重命名 > 删除，避免竞态覆盖。

### 验收标准（DoD）

- 新增音频文件后，在可接受时间内出现在库中。
- 删除文件后，库中记录自动清理。
- 重命名文件后，路径与展示同步更新，无“幽灵旧路径”。

---

## M3（P1）搜索后台化与结果分页

### 目标

- 搜索执行不阻塞 UI。
- 搜索结果展示避免一次性重建大量节点。

### 任务清单

- 在 `ui/pages/library_page_qt.py` 中将 `_execute_search` 切到 worker 执行。
- 结果返回采用“分批回传/分页拉取”模型。
- 增加 latest-wins 机制：新请求到达时取消旧请求结果应用。

### 验收标准（DoD）

- 连续输入关键词时，界面保持可交互。
- 大结果集搜索不出现明显冻结。
- 搜索结果与最终数据库条件一致，无重复/漏项。

---

## M4（P1）波形链路增强与缓存接入

### 目标

- 提升波形可用率与重复打开性能。

### 任务清单

- 在 `ui/widgets/qt_waveform_preview.py` 中扩展“安全多格式”策略。
- 将 `infrastructure/cache/waveform_cache.py` 接入波形加载流程。
- 建立失效策略：文件 mtime 变化后自动失效并重建。

### 验收标准（DoD）

- 常见格式（WAV/FLAC/MP3）具备可控预览能力（按安全策略逐步启用）。
- 同一文件重复预览时明显减少二次计算。
- 播放位置同步、点击 seek 行为正确。

---

## M5（P2）可观测性与压测验证

### 目标

- 给后续 1.3.0 的“百万级”优化提供量化基础。

### 任务清单

- 统一日志字段：导入吞吐、搜索耗时、波形命中率、监控事件量。
- 增加压测脚本与基准数据集说明（1 万 / 10 万）。
- 输出版本性能对比报告模板。

### 验收标准（DoD）

- 可重复执行的压测流程文档可用。
- 关键指标可在日志中直接提取。

---

## 4. 文件级实施映射

- `ui/pages/library_page_qt.py`
  - 导入后台化控制层。
  - 搜索 worker 化与结果分页应用。
  - 选择状态与右侧列表同步去抖。

- `ui/utils/workers.py`
  - 新增或扩展搜索 worker、导入任务状态对象。
  - 统一线程清理策略。

- `application/library_manager/file_watcher.py`
  - 主流程接线与事件回调协议标准化。

- `ui/main_window.py`
  - 任务中心入口、页面间状态联动。

- `ui/widgets/qt_waveform_preview.py`
  - 多格式策略、缓存接入、latest-wins 强化。

- `infrastructure/cache/waveform_cache.py`
  - 缓存命中统计、失效与清理策略接入。

---

## 5. 风险与应对

- 风险：后台任务并发导致状态错乱。
  - 应对：任务状态机 + 幂等写入 + 明确“终态”定义。

- 风险：文件监控事件风暴引发数据库抖动。
  - 应对：防抖窗口、事件去重、批量事务提交。

- 风险：多格式波形引入不稳定解码路径。
  - 应对：安全白名单 + 失败降级 + 可配置开关。

---

## 6. 回滚策略

- 开关级回滚：
  - 关闭后台导入展示，回退到现有同步导入页表现。
  - 关闭文件监控接线（保留手动刷新流程）。
  - 波形回退到 WAV-only 安全模式。

- 代码级回滚：
  - 各里程碑独立提交与验证，出现问题可按模块回退。

---

## 7. 交付节奏建议

- 第 1 周：M1（导入后台化）
- 第 2 周：M2（监控接线）
- 第 3 周：M3（搜索后台化）
- 第 4 周：M4（波形增强）
- 第 5 周：M5（压测与发布前验证）

---

## 8. 发布前检查清单

- 导入 1 万文件流程完整跑通（含中断恢复）。
- 10 万路径加载可进入可操作状态。
- 搜索连续输入无明显冻结。
- 监控增量同步正确（增/删/改）。
- 波形预览回退开关有效。
- 发布说明、已知问题、回滚说明齐全。

