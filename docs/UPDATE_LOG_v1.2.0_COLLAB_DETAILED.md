# 音译家 v1.2.0 协作更新总览（详细版）

> 文档说明：本文件基于本次完整协作会话整理，覆盖 UI 重构、架构调整、性能与稳定性修复、在线资源与 AI 工坊升级等内容。  
> 适用范围：`transcriptionist_v3` 当前分支。  
> 更新时间：2026-02-09

---

## 1. 本次版本定位

本轮更新不是“单点修补”，而是一次**产品级重构迭代**，目标是：

- 统一视觉语言（深/浅主题、页面节奏、控件基线、层级与状态表达）。
- 提升大数据量场景可用性（导入、翻译、索引、检索、打标）。
- 将关键能力从“能用”提升到“可持续迭代”（配置化、任务化、可观测）。
- 将 AI 音频生成能力从本地 MusicGen 路线切换到可灵 API 路线。

### 1.1 本轮迭代的真实起点（反编译 Soundly 学习驱动）

这次更新最初并不是从“改配色”开始，而是从**反编译 Soundly 的代码与交互行为学习**开始，并在此基础上做了系统化对标：

- 对标 Soundly 的信息架构：库页、工作台、在线资源、播放器的职责边界。
- 对标 Soundly 的大库处理思路：增量、分页、任务化、可恢复，而不是一次性全量阻塞。
- 对标 Soundly 的桌面端数据库路线：以本地 SQLite 作为主线，优先稳定与交付复杂度可控。
- 对标 Soundly 的交互节奏：状态条、工具栏、卡片/表格切换、播放与波形联动一致性。

> 说明：本项目是“学习其产品方法与工程策略”，不是拷贝实现。当前所有落地均按本项目代码结构与需求重写。

### 1.2 从 Soundly 学习到本项目落地的映射

- **方法层**：先审查瓶颈，再做 UI；先稳定链路，再追求视觉细节。
- **架构层**：导入、翻译、索引、检索统一纳入任务化与状态可观测。
- **体验层**：围绕“现代感 + 高密度 + 不拥挤 + 强反馈”反复微调。
- **性能层**：围绕十万/百万级音频的极端场景持续修复（参数上限、表达式树、并发策略、UI 卡顿）。

---

## 2. 视觉与交互系统重构（大厂风格统一）

### 2.1 主题系统 token 化（深/浅联动）

- 建立并持续扩展统一主题令牌体系（`ui/themes/theme_tokens.py`）。
- 页面样式从局部硬编码迁移到运行时 token QSS 叠加机制。
- 深色与浅色模式实现统一映射，修复“深背景黑字不可读”“弹窗配色跑偏”等问题。
- 修复多个子页面/弹窗不跟随主题的问题，要求与设置页主题一致。

### 2.2 顶部导航与状态条统一

- 统一“库页/工作台”顶部导航和状态条的：
  - 间距节奏
  - 字重层级
  - 文本基线对齐
  - 控件高度规范
- 标题栏状态文案做压缩，提升信息密度与专业感。

### 2.3 工作区布局交互升级

- 分栏/聚焦模式持续打磨，提升音效库与工作台切换效率。
- 折叠/展开入口改为更轻量化图标风格（Adobe 风格倾向）。
- 修复分栏模式下控件重叠、挤压、越界、错位等多处问题。

---

## 3. 音效库页面重构

### 3.1 卡片视图升级

- 卡片视觉风格从“原生感”升级为现代化卡片语言。
- 卡片细节持续迭代：
  - 字体层级优化
  - 状态徽章样式优化
  - hover 动效与反馈优化
- 清理冗余视觉元素（如“播/定/删”浮标样式问题）。

### 3.2 表格视图升级

- 统一表头高度、行高、列间距，纳入同一主题节奏。
- 修复切换表格模式时主题错乱问题。
- 支持列宽拖拽（用户可自定义表格列宽）。
- 修复表格未填满、卡片视图被连带影响等回归问题。

### 3.3 工具条统一节奏

- 顶部“导入 + 搜索 + 筛选”区域做统一高度与间距。
- 输入框与下拉框基线对齐，修复拥挤感与错位感。

---

## 4. 播放器与波形系统迭代

### 4.1 播放行为修复

- 修复暂停后前进/后退无效问题。
- 修复暂停后波形进度条无法拖动问题。
- 播放器底栏纳入统一 token 体系（按钮尺寸、轨道色、文本层级）。

### 4.2 波形渲染优化

- 卡片波形与播放波形持续优化风格与可读性。
- 对“专业工具感”做多轮精修：
  - 线宽、线间距、对比度
  - 真实频段偏置（低频更厚、中频更稳、高频更细碎）
- 修复波形相关报错与异常（如绘制依赖缺失、渲染异常）。

### 4.3 波形性能与并发控制

- 明确波形渲染并发管理方向：默认 4 线程。
- 增加“按 CPU 推荐线程数 + 用户可调”的设置思路并落地相关能力。
- 关注可见区域优先、缓存复用、避免无界增长导致内存压力。

---

## 5. 在线资源（Freesound）板块重构

### 5.1 页面结构与自适应

- 在线页在分栏/全屏两种模式下重做自适应布局。
- 顶部搜索区（搜索框/结果模式/按钮）统一高度与基线。
- 修复分栏模式下合集区挤压、标题截断、布局错位问题。

### 5.2 合集（Packs）能力增强

- 从静态推荐向实时拉取策略升级（热门 Pack、数量信息等）。
- 列表形态升级为平铺卡片形态（更符合现代素材平台展示方式）。
- 修复合集点击后多窗口弹出、数据错乱、占位图异常等问题。

### 5.3 搜索结果与翻译体验

- 搜索结果与合集内容逐步优化为一致视觉风格。
- 对“英文内容中文可读化”需求做了路径打通：优先走软件 AI 服务链路。
- 清理硬编码文案/硬编码翻译策略，向统一 AI 服务配置收敛。

---

## 6. AI 检索 / 翻译 / 打标板块优化

### 6.1 AI 检索页可用性修复

- 修复任务状态区拥挤、截断、展开/收起无效等问题。
- 新增任务状态清空按钮（按用户反馈提升可控性）。
- 修复“检索模式”下拉框文字展示不全、控件被挤压问题。
- 语义搜索页面进行结构重排与视觉统一。

### 6.2 检索策略模块收敛

- 对“检索策略”模块必要性进行了评估与简化。
- 从用户视角减少低价值配置，释放界面空间与认知负担。

### 6.3 AI 批量翻译体验修复

- 修复翻译规则窗口主题颜色不跟随的问题。
- 移除规则窗口 `#888` 等硬编码灰字，统一使用 token 语义色。
- 优化翻译板块对齐问题，减少“控件看起来不整齐”的观感问题。

---

## 7. 数据与架构方向收敛

### 7.1 数据库路线收敛为 SQLite 主线

- 根据产品定位与目标，明确收敛为 SQLite 路线。
- 避免 PostgreSQL 路线分叉导致运维复杂度上升。
- 结合对 Soundly 方向的学习，保持桌面端本地数据库方案一致性。

### 7.2 大规模数据场景问题聚焦

围绕用户反馈的典型痛点（十万/百万音效）进行了重点审查与修复落地方向：

- 大规模导入时的 SQL 参数/表达式限制问题（如 999 参数上限、表达式树过深）。
- AI 检索在大量目录条件下的超长 OR 查询问题（`Expression tree is too large`）。
- 批量翻译后替换/撤销替换的稳定性与耗时问题。
- 索引、打标、标签统计在大规模数据下的吞吐与内存压力问题。

---

## 8. AI 音效工坊（重大改版）

### 8.1 模块升级与改名

- 将“AI 音乐工坊实验室”重构为“AI 音效工坊”。
- 放弃旧本地 MusicGen 作为主路线，切换为可灵文本生成音效 API 路线。

### 8.2 新服务接入

- 新增可灵服务提供方封装：`application/ai_engine/providers/kling_audio.py`。
- 新增异步 Worker：`ui/utils/workers.py` 中 `KlingTextToAudioWorker`。
- 主窗口接入新页面与播放回放链路：`ui/main_window.py`。

### 8.3 设置与配置

- 新增/使用 AI 音效服务商配置项：
  - `ai.audio_provider`
  - `ai.audio_api_key`
  - `ai.audio_base_url`
  - `ai.audio_callback_url`
  - `ai.audio_poll_interval`
  - `ai.audio_task_timeout_seconds`
- 下线/隐藏旧 MusicGen 管理入口，逐步清理相关死代码。

### 8.4 参数真实性与 API 对齐

- “生成参数-时长”不是假 UI，已真实接入提交链路。
- 时长范围改为与 API 限制自动对齐：
  - 服务层定义限制常量
  - UI 自动读取并设置滑杆范围
  - 提交前做越界校验

### 8.5 主题联动完善

- AI 音效工坊页面已接入全局 token，深浅主题联动。
- 卡片/输入框/按钮/状态文本不再使用独立硬编码配色。

---

## 9. 设置页与性能配置审查

### 9.1 性能模块审查

重点审查了以下配置在当前版本中的有效性与性能影响：

- AI 批量翻译性能
- 导入音效性能管理
- AI 检索性能设置

并对“默认值是否影响速度”进行评估与优化建议落地。

### 9.2 配置文案整理

- 清理重复推荐文案，避免“新旧提示重叠”。
- 去掉低价值或冗余选项（如网络环境项在新推荐机制下的重复展示）。

---

## 10. 典型问题修复清单（节选）

- 修复多处主题颜色错乱、硬编码颜色、弹窗不跟随主题问题。
- 修复分栏模式下在线页/合集区挤压、截断、错位问题。
- 修复 AI 检索任务状态区域交互无效与排版拥挤问题。
- 修复表格视图切换导致视觉回归与布局异常问题。
- 修复播放器暂停后进度与跳转交互异常问题。
- 修复在线页图片/占位图加载与异常日志问题。
- 修复可灵接入中的线程/事件循环冲突与异常处理问题。

---

## 11. 依赖与工程化补充

- 持续补充文档体系（实施计划、发布说明、迁移与验收清单等）。
- 增强脚本化能力（发布就绪检查、基准与闸门相关脚本）。
- 保持代码结构向“可维护、可扩展、可回归验证”方向演进。

---

## 12. 本次更新价值总结

本轮更新核心价值可概括为三点：

1. **体验层**：UI 从“可用”迈向“统一、现代、专业”。
2. **能力层**：在线资源、AI 检索翻译、AI 音效生成形成更完整闭环。
3. **工程层**：配置化、任务化、主题 token 化与数据库路线收敛，为后续大版本打下稳定底座。

---

## 13. 下一步建议（v1.2.x 后续迭代）

- 完成百万级场景专项压测报告（导入/翻译/索引/检索/打标全链路）。
- 继续清理历史遗留硬编码样式，做到全局 token 覆盖率最大化。
- 对在线资源页面增加更完整的异步状态与失败重试可视化。
- 对 AI 音效工坊补充“任务历史/批量生成/失败重试”能力。
