# AI 检索与打标问题分析报告

基于运行日志与代码审查，对以下三个问题的原因与修复建议进行说明。

---

## 一、AI 检索音效速度很慢

### 现象
- 日志显示：6289 个文件建立索引约 **25 分钟**（23:56:44 → 00:22:34，约 1546 秒）。
- 分块模式：11 块，每块约 600 个文件，单块约 2–4 分钟。

### 原因分析
1. **索引阶段（建立 embedding）**  
   每个文件需要：  
   - 多进程下用 librosa 加载音频并计算 log-Mel（CPU 密集）；  
   - 按 batch 送入 GPU 做 CLAP 推理。  
   6289 文件 ÷ 8 进程、batch_size=8 时，总耗时主要由 **预处理时间** 和 **GPU 推理时间** 决定，当前耗时属于可预期范围，并非逻辑错误。

2. **搜索阶段（输入关键词后）**  
   日志中「Search worker started」到「displayed top 20 results」在 1 秒内完成，说明**检索本身很快**。若体感“慢”，多半是指**建索引**慢，而不是搜的时候慢。

### 建议
- **建索引加速**（在设置中）：  
  - 索引模式选「性能优先」；  
  - 适当提高「GPU 批大小」（如 8 或 16，视显存而定）；  
  - 提高「CPU 进程数」和「块大小」（在内存允许下）。  
- **保持现状**：若可接受 25 分钟建一次索引、之后搜索都很快，则无需改逻辑，只需在 UI 提示“首次建索引较久，完成后检索会很快”。

---

## 二、AI 检索完成后搜索结果不精准

### 现象
- 例如搜「搜搜的转场声音」「呼呼的转场声音」「撞击声」「Whoosh」时，结果里出现「05狗追车.wav」等与预期不完全匹配的文件。

### 可能原因

1. **模型与预处理一致性**  
   - 本项目使用 **Xenova/larger_clap_general**（ONNX），源自 **laion/larger_clap_general**。  
   - 当前实现：48kHz、64 mel、10 秒、log-Mel，与常见 CLAP 设置一致；但 Xenova 导出时的**输入 shape/归一化**若与 laion 官方不完全一致，会带来偏差。  
   - 建议：对照 Xenova 仓库的 preprocessing（若公开），核对 mel 的 shape、数值范围、是否做归一化等，确保与 ONNX 模型训练时一致。

2. **零样本检索的固有限制**  
   - CLAP 是零样本模型，未针对“转场声 / whoosh / 撞击”等细粒度标签微调，长尾查询出现不准是正常现象。  
   - 短查询（如 "Whoosh"）与长句（如 "The sound of a quick transition"）得到的文本向量不同，排序也会不同。

3. **相似度阈值与展示**  
   - 当前列表展示 top 20，且对相似度 > 0.4 的项标绿。若整体分数偏低（例如多数在 0.2–0.4），用户会感觉“不准”。  
   - 可考虑：  
     - 将“高匹配”绿色阈值从 0.4 降到 0.35，让更多结果被标为高匹配；  
     - 或在设置中提供“最低展示相似度”，过滤掉过低分数的结果。

### 已做修复（与官方 Python ClapProcessor 对齐）
- **优先使用官方 ClapProcessor**：当已安装 `transformers` 且本地模型目录可用时，使用 `ClapProcessor.from_pretrained(model_dir)` 做音频预处理，与 [laion/larger_clap_general](https://hf-mirror.com/laion/larger_clap_general) 官方 Python 端完全一致。  
- **回退**：若未安装 `transformers` 或 Processor 加载失败，回退到 librosa 预处理（`ref=1.0, amin=1e-10`），与 HuggingFace 期望近似对齐。

---

## 三、AI 智能打标完成后左侧标签面板只显示 2 个标签

### 现象
- 日志：`Loaded 2 tags from database`；  
- 打标了 6289 个文件，但左侧标签列表只有「城镇环境」「巨型蜘蛛」等 2 个标签。

### 原因分析
- 标签来自 **影视音效（753）** 预设，即 **UCS 长句 explanation**（如 "Steady air blows, like from a compressed can of air."）。  
- CLAP 对**长句**的相似度通常低于**短标签**；在默认置信度 **0.25** 下，多数 (音频, 长句标签) 的相似度低于 0.25，只有极少数标签（如与“城镇环境”“巨型蜘蛛”对应的两条）在多文件中超过 0.25。  
- 因此写入数据库的**不同标签名**很少，左侧面板按“标签名”聚合后只看到 2 个。

### 已做修复
- 在 **AI 检索页 → 智能打标** 中，当用户选择 **「影视音效（753）」** 时：  
  - 自动将 **置信度阈值** 设为 **0.18**；  
  - 并更新说明：影视音效为长句描述，建议 0.18–0.22。  
- 这样在不改打标逻辑的前提下，会有更多标签超过阈值，左侧面板会出现更多不同标签。

### 使用建议
- 使用「影视音效（753）」时，阈值建议保持在 **0.18–0.22**；若仍觉得标签偏少，可再降到 0.15 试一次。  
- 若希望标签更“少而准”，可选用「音效精简 (70+)」并配合稍高阈值（如 0.28–0.32）。

---

## 四、你提到的“严重 BUG 修复”的核对建议

你未给出具体修复内容，建议从以下几方面自检：

1. **索引与搜索**  
   - 分片索引下 `ChunkedSearchWorker` 是否正确使用 `index_dir`、`chunk_files` 和 `text_embed`，以及合并逻辑是否按路径去重并按相似度排序。  
   - 当前实现：按块加载、算余弦相似度、按块取 top 再合并、按路径取最大相似度、最后排序，逻辑正确。

2. **打标写入**  
   - `TaggingWorker` 中 `batch_updates` 的 `file_path` 是否与库页 `_file_metadata` 的 key 一致（含 `as_posix` 等），避免写了库但界面不刷新。  
   - 当前 `_on_tags_batch_updated` 已做路径容错，一般无问题。

3. **进度与线程**  
   - 建索引/打标进度回调是否在正确的线程 emit，避免 UI 卡死或崩溃。  
   - 当前进度为 (float, str)、节流 100ms、转换为 (percent, 100, msg)，与 UI 的 `_on_indexing_progress` 一致。

若你能贴出“严重 BUG”的修复 diff 或文件位置，可以再针对那一段做逐行审查。

---

## 五、小结

| 问题           | 结论                           | 已做/建议 |
|----------------|--------------------------------|-----------|
| 检索速度慢     | 建索引 25 分钟属预期；搜索很快  | 通过设置调大 batch/进程数；必要时在 UI 提示 |
| 搜索结果不精准 | 模型零样本 + 预处理需与 ONNX 一致 | 文档说明 + 可选绿色阈值 0.35 + 核对预处理 |
| 左侧只有 2 个标签 | 影视音效(753) 长句 + 阈值 0.25 过高 | 已改为选 753 时默认阈值 0.18 |

以上为本次分析与修改内容。若你提供“严重 BUG”的具体改动，可以再补一段针对性审查。
