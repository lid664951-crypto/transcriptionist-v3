# CLAP 音频语义检索优化说明

本文档说明针对「嵌入中心化」问题已实施的优化及用户须知。

---

## 问题简述

- **现象**：短音频（如约 3.2s）在多种不相关查询下都排第一，相似度普遍在 20%～26%，缺乏高置信度命中。
- **根因**：短文件用 `repeatpad`（np.tile 填满 10s）导致「同一段声音循环」，CLAP 产生泛化/中心化嵌入，与多种文本都有中等相似度。

---

## 已实施的更新

### P0：短文件零填充（已实施）

- **文件**：`application/ai/clap_preprocess.py` → `_pad_waveform`
- **逻辑**：
  - **时长 ≥ 3s**：仍用原有 repeatpad（tile 到 10s）。
  - **时长 < 3s**：不再 tile，直接零填充到 10s。
- **效果**：短于 3 秒的音频不再被重复拼接，避免中心化嵌入。

### P1：低分阈值过滤（已实施）

- **文件**：`ui/pages/ai_search_page_qt.py` → `_on_search_finished`
- **逻辑**：
  - 最小相似度阈值 **0.25**；仅展示 ≥25% 的结果。
  - 若**全部**结果都低于 25%：标题显示「无高置信度匹配」，列表显示「未找到高置信度匹配，建议尝试更具体的关键词或描述」，并弹出提示。
- **效果**：避免低置信度结果被当成「第一名」误导用户。

---

## 用户须知

- **重建索引**：P0 修改了短文件的填充方式，**请重新建立 AI 检索索引**（勾选文件 → 建立索引）后，检索效果才会与上述逻辑一致；否则短文件仍使用旧策略的嵌入。

---

## 可选后续方案（未实施）

- **P2 短文件降权**：索引中存时长，检索时对短文件降权；需改索引格式并重建索引。
- **P3 多段采样聚合**：对长音频（>10s）多段编码后均值聚合；需改 `clap_service.py` 并重建索引。
