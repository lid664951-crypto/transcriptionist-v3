# 音译家 AI 音效管理工具 v1.1.0 更新日志

> 本版本主要聚焦在「库界面重构」「大体量音效库的性能稳定性」以及「若干深层 BUG 修复」。

**发布日期**：2026-01-28  
**版本类型**：重大更新（Major）  

---

## 1. 更新概览

本次 v1.1.0 的目标：

- 让**库板块在大音效库（数万条）下依然可用，不再轻易卡死或爆内存**  
- 让**音效浏览体验更清晰：文件夹树和音效列表分离，各司其职**  
- 修复若干潜在的数据库 / 线程安全 / 重命名相关的深层问题  

---

## 2. 界面与交互改进

### 2.1 库板块重构为「纯文件夹树」

**改动内容：**

- 库页面 `LibraryPage` 现在：
  - 只在左侧树形控件中显示**文件夹结构**，**不再直接展示文件节点**
  - 支持多级嵌套目录（厂牌库、大合集等层级结构）
  - 勾选文件夹 = 选择该文件夹及其子目录下的音效  
  - 可勾选多个文件夹，供 AI 翻译 / AI 检索 / 音效列表合并显示使用
- 勾选/取消勾选行为：
  - 勾选一个或多个文件夹：中间的「音效列表」面板显示这些文件夹下的所有音效（去重）
  - 未勾选任何文件夹时：音效列表自动清空
  - 全选时：仍然支持将**全库文件列表**发给 AI 模块，但**音效列表不尝试一次性展示所有文件**，以保护性能

**技术要点：**

- `_update_tree_lazy()` 只构建「文件夹树」，不再向树中添加文件项  
- `_create_file_item_lazy()` 被废弃，仅作为兼容占位  
- 树节点的 `UserRole` 数据只标记 `type="folder"` + `path`，不再混入文件级数据  

---

### 2.2 新版「音效列表」面板（音效浏览专用）

**功能简介：**

- 工作台中新增（并强化）独立的 `AudioFilesPanel` 面板，用于展示当前勾选文件夹中的具体音效文件
- 支持：
  - 单个文件夹的所有音效
  - 多个文件夹合并后的所有音效（去重）
  - 双击播放音效
  - 右键菜单：播放 / 在资源管理器中显示 / 从库中移除（只删记录，不删物理文件）

**字段展示：**

- `音效名`：翻译后的名称；若未翻译，显示原文件名
- `原音效名`：在有翻译名时显示原名（灰色），否则为 `-`
- `标签`：已打标显示前若干个标签，未打标显示 `未打标`
- `时长`：以 `mm:ss` 格式显示
- `大小`：自动格式化为 KB/MB
- `格式`：文件扩展名（wav/mp3/flac 等）

**底部状态栏：**

- 实时显示当前列表总数和**已选择的文件数量**

---

### 2.3 音效列表采用「虚拟列表」实现

为适配数千级以上音效文件，`AudioFilesPanel` 内部实现做了重要升级：

- 将原来的 `QTreeWidget + QTreeWidgetItem` 改为：
  - `QTreeView + QAbstractTableModel`
  - 只在模型中维护 `list[dict]` 的数据结构
  - 视图层只渲染当前可见的几十行内容
- 对外接口保持兼容：
  - `set_folder_files(folder_path: str, files: List[dict])`
  - `clear()`
  - `get_selected_files() -> List[dict]`
  - 信号 `files_selected` / `request_play` / `request_remove` / `request_show_in_folder`
- 这样可以在几千条记录时仍保持滚动和选择的流畅性，并显著降低内存占用和 CPU 压力

---

## 3. 大体量音效库下的性能与稳定性

### 3.1 文件夹 → 文件列表映射（避免 O(N×M) 扫描）

**问题背景：**

- 旧版本在勾选某个文件夹时，会对 `_all_file_data` 中的所有文件一遍遍地做 `Path.relative_to()` 判断和磁盘 `stat()`，在 5–6 万条音效时 CPU 飙高、UI 假死。

**现状改进：**

- 在数据库加载完成后，`LibraryPage` 现在会构建一个**「文件夹路径 → 文件索引列表」**的映射：
  - `_build_folder_index()` 遍历 `_all_file_data`，按父目录分组记录索引
  - 勾选某个文件夹时：
    - 使用该索引快速拿到隶属该目录（及其子目录）的文件索引集合
    - 组装成 `AudioFilesPanel` 所需的 `file_info` 字典列表并去重
- 这大大降低了勾选/取消勾选多个文件夹时的 CPU 开销和 I/O 次数，使数万条库在日常操作中更稳定。

---

### 3.2 搜索防抖，避免频繁全库搜索

**旧行为：**

- 搜索框的 `searchSignal`、`textChanged`、`returnPressed` 都直接触发 `_on_search()`，在用户快速输入时会频繁全库搜索。

**新行为：**

- 引入 `QTimer` 防抖机制：
  - 所有与搜索相关的信号只会**重置一个 250ms 的单次计时器**
  - 真正的搜索逻辑放在 `_execute_search()` 中，计时器触发时执行
- 用户连续输入时，不会因为每打一个字就触发一次完整搜索，从而减少卡顿。

---

## 4. 数据库与线程安全 / 重命名相关修复

### 4.1 数据库线程安全：`DatabaseLoadWorker` 使用独立 Session

**修复点：**

- 旧实现中，`DatabaseLoadWorker.run()` 在 QThread 中调用 `get_session()` 获取 Session，存在跨线程复用 Session 的风险。
- 现已改为使用 `session_scope()`：
  - 每个 worker 线程在自身线程内创建 / 使用 / 关闭 Session
  - `finished` 信号在 `with` 块结束后发送，保证数据库连接已正确释放

### 4.2 重命名时的权限与标签写入问题

**改进内容：**

- 在 `RenamingService.rename_sync()` 中：
  - 增加对目标目录写权限的预检查（`os.access(parent_dir, os.W_OK)`），在明显无写权限时立刻返回友好错误信息，而不是让重命名失败但原因不明。
- 在 `_write_original_filename_sync()` 中：
  - 不再使用 `except: pass` 静默吞异常
  - 对 `add_tags()`、WAV 标签转换等错误记录 `logger.warning` 日志，方便排查
  - `PermissionError` 会抛出带详细说明的异常文本（只读文件、被占用等），上层可据此向用户提示

### 4.3 文件夹重命名时的数据库路径更新更安全

**问题：**

- 旧逻辑使用 `AudioFile.file_path.like(f"{old_path}{os.sep}%")` 做 SQL 匹配，如果路径中包含 `%`、`_` 等特殊字符，可能误匹配其他记录。

**修复：**

- 改为使用 `AudioFile.file_path.startswith(prefix)` 形式的条件构造，真正只更新以该路径为前缀的记录，避免误伤。

---

## 5. 其他质量改进

- **扫描实现统一为 `os.scandir()` 递归**：相对 `os.walk()` 有更好的性能表现。
- **导入/保存逻辑使用批处理（500 条/批）**：绕过 SQLite 单条 SQL 变量数量限制，同时减少事务提交次数，提升稳定性。
- **错误提示更友好**：  
  - 文件不存在 / 无权限 / 标签写入失败等情况增加了更明确的日志与信息文本。
- **部分旧代码的空 `except` 被清理**：  
  - 现在大多数异常至少会记录日志，避免“表面没问题、实际失败”的情况。

---

## 6. 已知问题与后续计划

> 以下为当前版本仍然存在或有待进一步优化的点，属于后续版本的演进方向。

1. **超大库（10 万+ 音效）下的极限性能**  
   - 目前在 5–6 万级别库下已可正常使用，但在极端规模下（10 万+）仍可能出现首次操作偏慢的情况。
   - 未来计划：
     - 更彻底地分页 / 分段加载
     - 将更多搜索和筛选逻辑下沉到数据库层或专用索引结构中。

2. **撤销 / 恢复机制**  
   - 当前删除库记录（从库中移除）是不可撤销的，虽然不会删除物理文件，但重新建库需要重新导入。
   - 未来版本考虑增加“最近删除批次恢复”或简单的撤销机制。

3. **CLAP 多进程索引与高级缓存机制**  
   - 目前 CLAP 索引侧已有批量处理和一定的性能优化，但未实现真正的多进程池和复杂缓存体系。
   - 未来可能会在保证稳定性的前提下逐步演进。

---

## 7. 升级建议

- **推荐升级场景：**
  - 使用大型厂牌音效库（数万条音效）的用户
  - 在 v1.0.x 中导入大量音效时经常遇到卡死、导入失败或“太多 SQL 变量”错误的用户

- **升级前建议：**
  - 备份 `data/database/transcriptionist.db`  
  - 如有自定义模型或配置，也建议一并备份 `data/models`、`data/index`、`settings` 等目录

- **升级后建议：**
  - 对于已存在的大库，可直接使用，不必强制重建索引  
  - 如发现任何新的性能问题或异常，请附带日志与复现步骤反馈

---

**最后更新时间**：2026-01-28  
**适用软件版本**：v1.1.0